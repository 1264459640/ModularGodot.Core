# 快速入门：生产基础设施的集成测试

## 概述
本指南提供了运行集成测试的说明，这些测试验证ModularGodot.Core框架中的组件通信和包完整性。

## 先决条件
- .NET 9.0或更高版本
- 支持.NET的Godot引擎
- 所有ModularGodot.Core NuGet包（Contracts, Contexts, Infrastructure, Repositories, Core）
- 访问ModularGodot.Core.Test项目
- Godot.NET.Sdk/4.5.0

## 运行集成测试

### 1. 构建解决方案
```bash
dotnet build src/ModularGodot.Core.sln
```

### 2. 在Godot编辑器中运行集成测试
- 打开Godot编辑器
- 加载ModularGodot.Core.Test项目
- 选择要测试的场景文件（MediatorTestScene.tscn, EventBusTestScene.tscn, PackageTestScene.tscn）
- 在场景中点击"RunTest"方法按钮执行测试

### 3. 通过命令行构建测试项目
```bash
# 构建测试项目
dotnet build src/ModularGodot.Core.Test/ModularGodot.Core.Test.csproj
```

## 测试配置

### 环境设置
集成测试配置为仅在开发环境中运行。这通过以下方式控制：

1. **测试配置**：测试在执行前检查环境设置
2. **条件执行**：测试使用自定义属性跳过在非开发环境中的执行
3. **应用设置**：配置文件指定当前环境

### Godot场景测试
测试使用Godot场景演示测试用例来模拟类似生产的场景：

1. **场景加载**：测试加载指定的Godot场景
2. **组件初始化**：框架组件在场景上下文中初始化
3. **场景执行**：测试场景在场景环境中执行
4. **结果验证**：基于场景交互验证测试结果

## 测试类别

### 中介者通信测试
- 验证通过中介者模式的命令路由
- 验证查询处理和响应
- 测试异常传播
- 测量中介者操作的性能

### 事件总线通信测试
- 验证事件发布给订阅者
- 测试选择性订阅行为
- 验证一次性订阅功能
- 检查订阅者之间的异常隔离

### 包完整性测试
- 验证所有必需NuGet包的存在
- 检查包版本一致性
- 验证包文件完整性
- 测试包集成和依赖关系

### 测试隔离测试
- 验证独立的测试执行
- 验证资源清理
- 检查副作用预防
- 测试并发执行

## 预期结果

### 成功标准
- 所有测试完成且无错误
- 组件通信按预期工作
- 所有包都存在且功能正常
- 测试仅在开发环境中运行
- 仅验证成功场景（无错误处理测试）

### 性能预期
- 单个测试执行时间 < 100ms
- 中介者路由时间 < 1ms
- 事件总线发布时间 < 10ms
- 测试间最小内存累积

## 故障排除

### 常见问题

1. **测试未在开发环境中运行**
   - 检查appsettings.json中的环境配置
   - 验证ASPNETCORE_ENVIRONMENT环境变量
   - 确保测试配置与开发设置匹配

2. **包未找到错误**
   - 验证所有NuGet包都已正确引用
   - 检查包版本是否与预期值匹配
   - 确保包还原成功完成

3. **组件通信失败**
   - 验证Autofac依赖注入是否正确配置
   - 检查所有必需服务是否已注册
   - 确保中介者和事件总线组件正确初始化

4. **资源清理问题**
   - 检查所有IDisposable资源是否正确处置
   - 验证文件句柄和连接是否已关闭
   - 确保测试清理方法正确实现

### 诊断
- 为测试执行启用详细日志记录
- 使用测试输出助手捕获诊断信息
- 检查测试结果中的特定错误消息
- 查看测试日志中的性能指标

## 后续步骤
成功运行集成测试后，您可以：
1. 查看测试结果和性能指标
2. 为新功能添加其他集成测试
3. 随需求演变修改现有测试
4. 将测试集成到CI/CD管道中进行自动化验证