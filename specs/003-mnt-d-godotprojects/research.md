# 研究：生产基础设施的集成测试

## 决策
使用现有的ModularGodot.Core.Test项目结构，通过Godot场景进行集成测试，利用Godot引擎的场景系统来验证ModularGodot.Core框架组件。

## 理由
1. **利用现有基础设施**：ModularGodot.Core.Test项目已经配置了Godot.NET.Sdk/4.5.0，可以直接使用。
2. **遵循项目约定**：使用Godot场景测试符合Godot项目的测试实践。
3. **减少设置开销**：无需配置新的测试框架，节省时间和减少配置错误。
4. **与当前构建流程集成**：现有的测试项目已经集成到构建和CI/CD管道中。

## 考虑的替代方案
1. **创建单独的测试项目**：
   - 优点：更清晰地组织测试结构
   - 缺点：增加项目设置和维护开销

## 最佳实践研究

### Godot场景集成测试
- 使用`[Tool]`属性创建可在编辑器中运行的测试场景
- 实现`Node`的生命周期方法进行测试初始化和清理
- 通过直接方法调用验证组件间通信
- 通过场景树管理测试依赖关系
- 测试需要在Godot编辑器中启动，通过选择需要测试的场景进行测试

### 依赖注入测试模式
- 通过MiddlewareProvider单例获取中介者和事件总线实例
- 使用MiddlewareProvider.Instance.ResolveDispatcher()获取IDispatcher
- 使用MiddlewareProvider.Instance.ResolveEventBus()获取IEventBus
- 不需要手动配置Autofac容器，直接使用已配置的服务
- 使用TryResolve方法安全地获取服务实例

### MediatR模式测试方法
- 通过实际的命令/查询处理器测试中介者行为
- 在场景中模拟外部依赖，同时保持中介者管道完整
- 验证通过中介者的命令和查询路由
- 测试管道中的异常处理和验证

### R3事件系统测试策略
- 使用`TestScheduler`控制基于时间的事件序列
- 创建测试观察者捕获和验证事件发射
- 测试事件订阅和取消订阅行为
- 验证通过管道的事件数据完整性和转换

## 实现方法

### 测试结构
- 在场景中组织测试，匹配组件结构（中介者、事件总线、包）
- 使用描述性的场景和节点名称
- 将测试设置逻辑分离到可重用的辅助类中

### 测试环境
- 使用内存实现加速测试执行
- 通过配置文件或环境变量配置测试专用设置
- 实现适当的测试隔离以防止测试间的副作用

### 性能考虑
- 目标是每个测试<100ms执行时间
- 在适当时使用异步模式避免阻塞
- 通过缓存或在安全时共享来最小化昂贵的设置操作