# æŠ€æœ¯æ¶æ„æ–‡æ¡£ - ModularGodot.Core

## ğŸ“‹ ç›®å½•

- [æŠ€æœ¯æ¦‚è¿°](#æŠ€æœ¯æ¦‚è¿°)
- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
- [æ¶æ„å†³ç­–](#æ¶æ„å†³ç­–)
- [è®¾è®¡æ¨¡å¼](#è®¾è®¡æ¨¡å¼)
- [ä¾èµ–ç®¡ç†](#ä¾èµ–ç®¡ç†)
- [æ€§èƒ½è€ƒé‡](#æ€§èƒ½è€ƒé‡)
- [å®‰å…¨æ€§](#å®‰å…¨æ€§)
- [å¯æ‰©å±•æ€§](#å¯æ‰©å±•æ€§)
- [æŠ€æœ¯å€ºåŠ¡](#æŠ€æœ¯å€ºåŠ¡)

## æŠ€æœ¯æ¦‚è¿°

ModularGodot.Core æ˜¯ä¸€ä¸ªåŸºäº .NET 9.0 å’Œ Godot 4.4 çš„ä¼ä¸šçº§æ¸¸æˆå¼€å‘æ¡†æ¶ï¼Œé‡‡ç”¨ç°ä»£ C# è®¾è®¡æ¨¡å¼å’Œå“åº”å¼ç¼–ç¨‹ç†å¿µã€‚

### æ ¸å¿ƒæŠ€æœ¯ç†å¿µ

- **åˆ†å±‚æ¶æ„**ï¼šæ¸…æ™°çš„èŒè´£åˆ†ç¦»å’Œä¾èµ–ç®¡ç†
- **äº‹ä»¶é©±åŠ¨**ï¼šåŸºäºå“åº”å¼ç¼–ç¨‹çš„æ¾è€¦åˆè®¾è®¡
- **ä¾èµ–æ³¨å…¥**ï¼šæ§åˆ¶åè½¬æé«˜å¯æµ‹è¯•æ€§
- **ä¸­ä»‹è€…æ¨¡å¼**ï¼šè§£è€¦ä¸šåŠ¡é€»è¾‘å¤„ç†
- **èµ„æºç®¡ç†**ï¼šæ™ºèƒ½ç¼“å­˜å’Œå†…å­˜ä¼˜åŒ–

## æŠ€æœ¯æ ˆ

### æ ¸å¿ƒæ¡†æ¶

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” | é€‰æ‹©ç†ç”± |
|------|------|------|----------|
| **.NET** | 9.0 | è¿è¡Œæ—¶å¹³å° | æœ€æ–°LTSç‰ˆæœ¬ï¼Œæ€§èƒ½ä¼˜åŒ–ï¼Œç°ä»£C#ç‰¹æ€§ |
| **Godot** | 4.4.1 | æ¸¸æˆå¼•æ“ | å¼€æºã€è½»é‡çº§ã€C#æ”¯æŒå®Œå–„ |
| **C#** | 12.0 | ç¼–ç¨‹è¯­è¨€ | å¼ºç±»å‹ã€é¢å‘å¯¹è±¡ã€ä¸°å¯Œç”Ÿæ€ |

### ä¾èµ–æ³¨å…¥ä¸IoC

| åº“ | ç‰ˆæœ¬ | ç”¨é€” | é€‰æ‹©ç†ç”± |
|-----|------|------|----------|
| **Autofac** | 8.3.0 | IoCå®¹å™¨ | åŠŸèƒ½å¼ºå¤§ã€æ€§èƒ½ä¼˜ç§€ã€æ¨¡å—åŒ–æ”¯æŒ |
| **MediatR** | 12.5.0/13.0.0 | ä¸­ä»‹è€…æ¨¡å¼ | è§£è€¦ä¸šåŠ¡é€»è¾‘ã€æ”¯æŒç®¡é“è¡Œä¸º |
| **MediatR.Extensions.Autofac** | 12.3.0 | é›†æˆæ‰©å±• | æ— ç¼é›†æˆAutofacå’ŒMediatR |

### ç¼“å­˜ä¸å†…å­˜ç®¡ç†

| åº“ | ç‰ˆæœ¬ | ç”¨é€” | é€‰æ‹©ç†ç”± |
|-----|------|------|----------|
| **Microsoft.Extensions.Caching.Memory** | 9.0.7 | å†…å­˜ç¼“å­˜ | å®˜æ–¹å®ç°ã€æ€§èƒ½ä¼˜åŒ–ã€æ˜“äºä½¿ç”¨ |
| **Microsoft.Extensions.Caching.Abstractions** | 9.0.7 | ç¼“å­˜æŠ½è±¡ | æ ‡å‡†æ¥å£ã€ä¾¿äºæ‰©å±• |

### å“åº”å¼ç¼–ç¨‹

| åº“ | ç‰ˆæœ¬ | ç”¨é€” | é€‰æ‹©ç†ç”± |
|-----|------|------|----------|
| **System.Reactive** | 6.0.0 | å“åº”å¼æ‰©å±• | æˆç†Ÿçš„Rxå®ç°ã€ä¸°å¯Œçš„æ“ä½œç¬¦ |
| **R3** | 1.3.0 | ç°ä»£å“åº”å¼åº“ | é«˜æ€§èƒ½ã€é›¶åˆ†é…ã€Unity/Godotä¼˜åŒ– |

## æ¶æ„å†³ç­–

### ADR-001: åˆ†å±‚æ¶æ„è®¾è®¡

**å†³ç­–**ï¼šé‡‡ç”¨4å±‚æ¶æ„æ¨¡å¼
- 0_Contracts: å¥‘çº¦å±‚
- 1_Contexts: ä¸Šä¸‹æ–‡å±‚  
- 2_Infrastructure: åŸºç¡€è®¾æ–½å±‚
- 3_Repositories: ä»“å‚¨å±‚

**ç†ç”±**ï¼š
- æ¸…æ™°çš„èŒè´£åˆ†ç¦»
- ä¾èµ–æ–¹å‘å•ä¸€ï¼ˆå‘å†…ä¾èµ–ï¼‰
- ä¾¿äºæµ‹è¯•å’Œç»´æŠ¤
- æ”¯æŒæ¨¡å—åŒ–å¼€å‘

**åæœ**ï¼š
- å¢åŠ äº†é¡¹ç›®å¤æ‚åº¦
- éœ€è¦æ›´å¤šçš„æ¥å£å®šä¹‰
- å­¦ä¹ æˆæœ¬è¾ƒé«˜

### ADR-002: ä¾èµ–æ³¨å…¥å®¹å™¨é€‰æ‹©

**å†³ç­–**ï¼šé€‰æ‹©Autofacä½œä¸ºIoCå®¹å™¨

**ç†ç”±**ï¼š
- åŠŸèƒ½ä¸°å¯Œï¼ˆæ¨¡å—åŒ–ã€è£…é¥°å™¨ã€æ‹¦æˆªå™¨ï¼‰
- æ€§èƒ½ä¼˜ç§€
- ä¸MediatRé›†æˆè‰¯å¥½
- æ”¯æŒå¤æ‚çš„æ³¨å†Œåœºæ™¯

**æ›¿ä»£æ–¹æ¡ˆ**ï¼š
- Microsoft.Extensions.DependencyInjectionï¼šåŠŸèƒ½ç›¸å¯¹ç®€å•
- Castle Windsorï¼šé…ç½®å¤æ‚
- Unityï¼šå¾®è½¯å·²åœæ­¢ç»´æŠ¤

### ADR-003: äº‹ä»¶ç³»ç»Ÿè®¾è®¡

**å†³ç­–**ï¼šé‡‡ç”¨R3 + System.ReactiveåŒé‡äº‹ä»¶ç³»ç»Ÿ

**ç†ç”±**ï¼š
- R3ï¼šé«˜æ€§èƒ½ã€é›¶åˆ†é…ã€é€‚åˆæ¸¸æˆåœºæ™¯
- System.Reactiveï¼šæˆç†Ÿç¨³å®šã€ä¸°å¯Œæ“ä½œç¬¦
- åŒé‡é€‰æ‹©æ»¡è¶³ä¸åŒæ€§èƒ½éœ€æ±‚

**å®ç°**ï¼š
```csharp
public interface IEventBus
{
    void Publish<T>(T eventData) where T : class;
    IDisposable Subscribe<T>(Action<T> handler) where T : class;
    IObservable<T> GetObservable<T>() where T : class;
}
```

### ADR-004: ä¸­ä»‹è€…æ¨¡å¼å®ç°

**å†³ç­–**ï¼šä½¿ç”¨MediatRå®ç°CQRSæ¨¡å¼

**ç†ç”±**ï¼š
- è§£è€¦è¯·æ±‚å‘é€è€…å’Œå¤„ç†è€…
- æ”¯æŒç®¡é“è¡Œä¸ºï¼ˆæ—¥å¿—ã€éªŒè¯ã€ç¼“å­˜ï¼‰
- ä¾¿äºå•å…ƒæµ‹è¯•
- ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™

**å®ç°**ï¼š
```csharp
public interface IMyMediator
{
    Task<TResponse> Send<TResponse>(ICommand<TResponse> command);
    Task<TResponse> Send<TResponse>(IQuery<TResponse> query);
}
```

## è®¾è®¡æ¨¡å¼

### 1. é€‚é…å™¨æ¨¡å¼ (Adapter Pattern)

**ç”¨é€”**ï¼šéš”ç¦»ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œä¿æŒæ¥å£ä¸€è‡´æ€§

```csharp
// MediatRé€‚é…å™¨
public class MediatRAdapter : IMyMediator
{
    private readonly IMediator _mediatR;
    
    public Task<TResponse> Send<TResponse>(ICommand<TResponse> command)
    {
        var wrapper = new MediatRRequestAdapter<TResponse>(command);
        return _mediatR.Send(wrapper);
    }
}
```

### 2. ç­–ç•¥æ¨¡å¼ (Strategy Pattern)

**ç”¨é€”**ï¼šèµ„æºåŠ è½½ã€ç¼“å­˜ç­–ç•¥ç­‰å¯æ’æ‹”å®ç°

```csharp
public interface IResourceLoader
{
    Task<T> LoadAsync<T>(string path) where T : Resource;
    bool CanLoad(string path);
}
```

### 3. è§‚å¯Ÿè€…æ¨¡å¼ (Observer Pattern)

**ç”¨é€”**ï¼šäº‹ä»¶é©±åŠ¨æ¶æ„çš„æ ¸å¿ƒ

```csharp
public interface IEventSubscriber
{
    IDisposable Subscribe<T>(Action<T> handler) where T : class;
}
```

### 4. å•ä¾‹æ¨¡å¼ (Singleton Pattern)

**ç”¨é€”**ï¼šå…¨å±€æœåŠ¡ç®¡ç†

```csharp
[Injectable]
public class ResourceManager : IResourceManager
{
    // é€šè¿‡IoCå®¹å™¨ç®¡ç†å•ä¾‹ç”Ÿå‘½å‘¨æœŸ
}
```

## ä¾èµ–ç®¡ç†

### é¡¹ç›®ä¾èµ–å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Game Logic    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   1_Contexts    â”‚â”€â”€â”€â–¶â”‚   0_Contracts   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                     â–²
          â–¼                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚2_Infrastructure â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3_Repositories  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åŒ…ç‰ˆæœ¬ç®¡ç†ç­–ç•¥

1. **ä¸»ç‰ˆæœ¬é”å®š**ï¼šé¿å…ç ´åæ€§å˜æ›´
2. **æ¬¡ç‰ˆæœ¬æ›´æ–°**ï¼šå®šæœŸæ›´æ–°è·å–æ–°ç‰¹æ€§
3. **è¡¥ä¸ç‰ˆæœ¬**ï¼šåŠæ—¶æ›´æ–°ä¿®å¤å®‰å…¨é—®é¢˜
4. **ä¾èµ–å®¡è®¡**ï¼šå®šæœŸæ£€æŸ¥æ¼æ´å’Œè¿‡æ—¶ä¾èµ–

### è‡ªåŠ¨æ³¨å†Œæœºåˆ¶

```csharp
// åŸºäºç‰¹æ€§çš„è‡ªåŠ¨æ³¨å†Œ
[Injectable]
public class MemoryCacheService : IMemoryCacheService
{
    // è‡ªåŠ¨æ³¨å†Œä¸ºå•ä¾‹
}

// è·³è¿‡è‡ªåŠ¨æ³¨å†Œ
[SkipRegistration]
public class ManualService : IManualService
{
    // éœ€è¦æ‰‹åŠ¨æ³¨å†Œ
}
```

## æ€§èƒ½è€ƒé‡

### 1. å†…å­˜ç®¡ç†

- **å¯¹è±¡æ± **ï¼šå¤ç”¨é¢‘ç¹åˆ›å»ºçš„å¯¹è±¡
- **å¼±å¼•ç”¨**ï¼šé¿å…å†…å­˜æ³„æ¼
- **åŠæ—¶é‡Šæ”¾**ï¼šå®ç°IDisposableæ¨¡å¼
- **GCä¼˜åŒ–**ï¼šå‡å°‘å¤§å¯¹è±¡å †åˆ†é…

### 2. äº‹ä»¶ç³»ç»Ÿä¼˜åŒ–

- **R3é›¶åˆ†é…**ï¼šæ¸¸æˆå¾ªç¯ä¸­ä½¿ç”¨R3
- **äº‹ä»¶è¿‡æ»¤**ï¼šé¿å…ä¸å¿…è¦çš„å¤„ç†
- **æ‰¹é‡å¤„ç†**ï¼šåˆå¹¶ç›¸ä¼¼äº‹ä»¶
- **å¼‚æ­¥å¤„ç†**ï¼šé¿å…é˜»å¡ä¸»çº¿ç¨‹

### 3. ç¼“å­˜ç­–ç•¥

```csharp
public class CacheConfig
{
    public TimeSpan DefaultExpiration { get; set; } = TimeSpan.FromMinutes(30);
    public int MaxCacheSize { get; set; } = 1000;
    public bool EnableCompression { get; set; } = true;
}
```

### 4. èµ„æºåŠ è½½ä¼˜åŒ–

- **å¼‚æ­¥åŠ è½½**ï¼šé¿å…é˜»å¡
- **é¢„åŠ è½½**ï¼šæå‰åŠ è½½å…³é”®èµ„æº
- **æµå¼åŠ è½½**ï¼šå¤§æ–‡ä»¶åˆ†å—å¤„ç†
- **å‹ç¼©å­˜å‚¨**ï¼šå‡å°‘å†…å­˜å ç”¨

## å®‰å…¨æ€§

### 1. è¾“å…¥éªŒè¯

```csharp
public class ValidatedCommand : ICommand<bool>
{
    [Required]
    [StringLength(100)]
    public string Name { get; set; }
    
    [Range(1, 1000)]
    public int Value { get; set; }
}
```

### 2. å¼‚å¸¸å¤„ç†

```csharp
public class GlobalExceptionHandler : IPipelineBehavior<IRequest<TResponse>, TResponse>
{
    public async Task<TResponse> Handle(IRequest<TResponse> request, 
        RequestHandlerDelegate<TResponse> next, 
        CancellationToken cancellationToken)
    {
        try
        {
            return await next();
        }
        catch (Exception ex)
        {
            // è®°å½•æ—¥å¿—ï¼Œè¿”å›å®‰å…¨å“åº”
            _logger.LogError(ex, "å¤„ç†è¯·æ±‚æ—¶å‘ç”Ÿé”™è¯¯");
            throw;
        }
    }
}
```

### 3. èµ„æºè®¿é—®æ§åˆ¶

- **è·¯å¾„éªŒè¯**ï¼šé˜²æ­¢ç›®å½•éå†æ”»å‡»
- **æ–‡ä»¶ç±»å‹æ£€æŸ¥**ï¼šé™åˆ¶å¯åŠ è½½çš„èµ„æºç±»å‹
- **å¤§å°é™åˆ¶**ï¼šé˜²æ­¢å†…å­˜è€—å°½æ”»å‡»

## å¯æ‰©å±•æ€§

### 1. æ¨¡å—åŒ–è®¾è®¡

```csharp
public class CustomModule : Module
{
    protected override void Load(ContainerBuilder builder)
    {
        builder.RegisterType<CustomService>()
               .As<ICustomService>()
               .SingleInstance();
    }
}
```

### 2. æ’ä»¶æ¶æ„

- **æ¥å£å®šä¹‰**ï¼šæ ‡å‡†åŒ–æ’ä»¶æ¥å£
- **åŠ¨æ€åŠ è½½**ï¼šè¿è¡Œæ—¶åŠ è½½æ’ä»¶
- **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šæ’ä»¶çš„å¯åŠ¨å’Œåœæ­¢
- **é…ç½®ç®¡ç†**ï¼šæ’ä»¶é…ç½®çš„ç»Ÿä¸€ç®¡ç†

### 3. äº‹ä»¶æ‰©å±•

```csharp
// è‡ªå®šä¹‰äº‹ä»¶
public class CustomGameEvent
{
    public string EventType { get; set; }
    public object Data { get; set; }
    public DateTime Timestamp { get; set; }
}

// äº‹ä»¶å¤„ç†å™¨
public class CustomEventHandler : INotificationHandler<CustomGameEvent>
{
    public Task Handle(CustomGameEvent notification, CancellationToken cancellationToken)
    {
        // å¤„ç†è‡ªå®šä¹‰äº‹ä»¶
        return Task.CompletedTask;
    }
}
```

## æŠ€æœ¯å€ºåŠ¡

### å½“å‰å·²çŸ¥é—®é¢˜

1. **æµ‹è¯•è¦†ç›–ç‡ä¸è¶³**
   - ä¼˜å…ˆçº§ï¼šé«˜
   - è®¡åˆ’ï¼šQ1 2024å®Œæˆå•å…ƒæµ‹è¯•
   - å½±å“ï¼šä»£ç è´¨é‡å’Œç»´æŠ¤æ€§

2. **æ–‡æ¡£ä¸å®Œæ•´**
   - ä¼˜å…ˆçº§ï¼šä¸­
   - è®¡åˆ’ï¼šæŒç»­æ›´æ–°
   - å½±å“ï¼šå¼€å‘æ•ˆç‡

3. **æ€§èƒ½åŸºå‡†æµ‹è¯•ç¼ºå¤±**
   - ä¼˜å…ˆçº§ï¼šä¸­
   - è®¡åˆ’ï¼šQ2 2024å»ºç«‹åŸºå‡†
   - å½±å“ï¼šæ€§èƒ½ä¼˜åŒ–æ–¹å‘ä¸æ˜ç¡®

### æŠ€æœ¯æ”¹è¿›è®¡åˆ’

1. **å¼•å…¥ä»£ç åˆ†æå·¥å…·**
   - SonarQubeï¼šä»£ç è´¨é‡åˆ†æ
   - Roslyn Analyzersï¼šç¼–è¯‘æ—¶æ£€æŸ¥
   - StyleCopï¼šä»£ç é£æ ¼ç»Ÿä¸€

2. **CI/CDæµæ°´çº¿ä¼˜åŒ–**
   - è‡ªåŠ¨åŒ–æµ‹è¯•
   - ä»£ç è¦†ç›–ç‡æŠ¥å‘Š
   - è‡ªåŠ¨åŒ–éƒ¨ç½²

3. **ç›‘æ§å’Œè¯Šæ–­**
   - Application Insightsé›†æˆ
   - æ€§èƒ½è®¡æ•°å™¨
   - å†…å­˜æ³„æ¼æ£€æµ‹

---

## æ€»ç»“

ModularGodot.Coreé‡‡ç”¨ç°ä»£.NETæŠ€æœ¯æ ˆï¼Œé€šè¿‡åˆ†å±‚æ¶æ„ã€ä¾èµ–æ³¨å…¥ã€äº‹ä»¶é©±åŠ¨ç­‰è®¾è®¡æ¨¡å¼ï¼Œä¸ºGodotæ¸¸æˆå¼€å‘æä¾›äº†ä¸€ä¸ªå¯æ‰©å±•ã€å¯ç»´æŠ¤ã€é«˜æ€§èƒ½çš„æ¡†æ¶åŸºç¡€ã€‚

æŠ€æœ¯é€‰å‹æ³¨é‡å¹³è¡¡åŠŸèƒ½æ€§ã€æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ï¼Œä¸ºæœªæ¥çš„æ‰©å±•å’Œä¼˜åŒ–ç•™ä¸‹äº†å……è¶³çš„ç©ºé—´ã€‚