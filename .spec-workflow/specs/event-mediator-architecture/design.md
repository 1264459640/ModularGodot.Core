# è®¾è®¡è§„èŒƒ - äº‹ä»¶ç³»ç»Ÿå’Œä¸­ä»‹è€…æ¨¡å¼æ¶æ„

## ğŸ“‹ ç›®å½•

- [è®¾è®¡æ¦‚è¿°](#è®¾è®¡æ¦‚è¿°)
- [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
- [ç»„ä»¶è®¾è®¡](#ç»„ä»¶è®¾è®¡)
- [æ¥å£è®¾è®¡](#æ¥å£è®¾è®¡)
- [æ•°æ®æµè®¾è®¡](#æ•°æ®æµè®¾è®¡)
- [å®‰å…¨è®¾è®¡](#å®‰å…¨è®¾è®¡)
- [æ€§èƒ½è®¾è®¡](#æ€§èƒ½è®¾è®¡)
- [æ‰©å±•æ€§è®¾è®¡](#æ‰©å±•æ€§è®¾è®¡)

## è®¾è®¡æ¦‚è¿°

### è®¾è®¡åŸåˆ™

åŸºäº"åˆ†ç¦»æŠ½è±¡ä¸å®ç°"çš„æ ¸å¿ƒåŸåˆ™ï¼Œæœ¬è®¾è®¡é‡‡ç”¨ä»¥ä¸‹å…³é”®ç­–ç•¥ï¼š

1. **å¥‘çº¦ä¼˜å…ˆè®¾è®¡**ï¼šæ‰€æœ‰ç»„ä»¶é€šè¿‡ç¨³å®šçš„æ¥å£å¥‘çº¦äº¤äº’
2. **é€‚é…å™¨æ¨¡å¼**ï¼šéš”ç¦»ç¬¬ä¸‰æ–¹åº“ä¾èµ–ï¼Œä¿æŒæ¶æ„çº¯å‡€
3. **åˆ†å±‚æ¶æ„**ï¼šæ¸…æ™°çš„èŒè´£åˆ†ç¦»å’Œä¾èµ–æ–¹å‘
4. **é›¶åˆ†é…ä¼˜åŒ–**ï¼šå…³é”®è·¯å¾„çš„å†…å­˜åˆ†é…ä¼˜åŒ–

### è®¾è®¡ç›®æ ‡

- **ç¨³å®šæ€§**ï¼šæ ¸å¿ƒAPIé•¿æœŸç¨³å®šï¼Œé¿å…ç ´åæ€§å˜æ›´
- **æ€§èƒ½**ï¼šäº‹ä»¶åˆ†å‘å»¶è¿Ÿ < 1msï¼Œé›¶å†…å­˜åˆ†é…
- **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒè¿è¡Œæ—¶æ’ä»¶åŠ è½½å’Œå®ç°æ›¿æ¢
- **å¯ç»´æŠ¤æ€§**ï¼šæ¸…æ™°çš„ä»£ç ç»“æ„å’Œå®Œæ•´çš„æ–‡æ¡£

## æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Plugin Ecosystem                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   Plugin A  â”‚  â”‚   Plugin B  â”‚  â”‚   Plugin C  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚                   â”‚
                      â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Contracts Layer                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚   IEventBus     â”‚  â”‚   IMyMediator   â”‚                  â”‚
â”‚  â”‚   IEventData    â”‚  â”‚   ICommand<T>   â”‚                  â”‚
â”‚  â”‚   ISubscriber   â”‚  â”‚   IQuery<T>     â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚                   â”‚
                      â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Infrastructure Layer                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚  R3EventBus     â”‚  â”‚ MediatRAdapter  â”‚                  â”‚
â”‚  â”‚  (Zero Alloc)   â”‚  â”‚ (Anti-Corrupt)  â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚                   â”‚
                      â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 External Libraries                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚       R3        â”‚  â”‚    MediatR      â”‚                  â”‚
â”‚  â”‚  (Reactive)     â”‚  â”‚   (CQRS)        â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¾èµ–å…³ç³»

```
Plugins â†’ Contracts â† Infrastructure â†’ External Libraries
```

**å…³é”®ç‰¹å¾**ï¼š
- æ‰€æœ‰ä¾èµ–ç®­å¤´æŒ‡å‘Contractså±‚
- Infrastructureå±‚å¯ç‹¬ç«‹æ›´æ–°
- Pluginsä¸External Librarieså®Œå…¨éš”ç¦»

### åˆ†å±‚èŒè´£

#### 1. Contracts Layer (å¥‘çº¦å±‚)
- **èŒè´£**ï¼šå®šä¹‰ç¨³å®šçš„APIå¥‘çº¦
- **åŒ…å«**ï¼šæ¥å£å®šä¹‰ã€æ•°æ®ç»“æ„ã€æšä¸¾å¸¸é‡
- **ä¾èµ–**ï¼šé›¶å¤–éƒ¨ä¾èµ–
- **ç‰ˆæœ¬ç­–ç•¥**ï¼šæå…¶ä¿å®ˆçš„ç‰ˆæœ¬æ›´æ–°

#### 2. Infrastructure Layer (åŸºç¡€è®¾æ–½å±‚)
- **èŒè´£**ï¼šæä¾›å…·ä½“å®ç°å’Œé€‚é…å™¨
- **åŒ…å«**ï¼šäº‹ä»¶æ€»çº¿å®ç°ã€ä¸­ä»‹è€…é€‚é…å™¨
- **ä¾èµ–**ï¼šContracts + ç¬¬ä¸‰æ–¹åº“
- **ç‰ˆæœ¬ç­–ç•¥**ï¼šç‹¬ç«‹ç‰ˆæœ¬ï¼Œå‘åå…¼å®¹

#### 3. Plugin Layer (æ’ä»¶å±‚)
- **èŒè´£**ï¼šä¸šåŠ¡é€»è¾‘å®ç°
- **åŒ…å«**ï¼šæ¸¸æˆæ¨¡å—ã€æ‰©å±•åŠŸèƒ½
- **ä¾èµ–**ï¼šä»…ä¾èµ–Contracts
- **ç‰ˆæœ¬ç­–ç•¥**ï¼šç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²

## ç»„ä»¶è®¾è®¡

### 1. äº‹ä»¶ç³»ç»Ÿç»„ä»¶

#### EventBusæ ¸å¿ƒç»„ä»¶

```csharp
// å¥‘çº¦å®šä¹‰
public interface IEventBus
{
    void Publish<T>(T eventData) where T : class;
    IDisposable Subscribe<T>(Action<T> handler) where T : class;
    IObservable<T> GetObservable<T>() where T : class;
}

// R3å®ç°
public class R3EventBus : IEventBus
{
    private readonly ConcurrentDictionary<Type, Subject<object>> _subjects;
    private readonly CompositeDisposable _disposables;
    
    public void Publish<T>(T eventData) where T : class
    {
        if (_subjects.TryGetValue(typeof(T), out var subject))
        {
            subject.OnNext(eventData);
        }
    }
    
    public IDisposable Subscribe<T>(Action<T> handler) where T : class
    {
        var subject = _subjects.GetOrAdd(typeof(T), _ => new Subject<object>());
        return subject.OfType<T>().Subscribe(handler);
    }
}
```

#### äº‹ä»¶æ•°æ®ç»“æ„

```csharp
// åŸºç¡€äº‹ä»¶æ¥å£
public interface IEventData
{
    DateTime Timestamp { get; }
    string EventId { get; }
}

// æ¸¸æˆäº‹ä»¶åŸºç±»
public abstract class GameEventBase : IEventData
{
    public DateTime Timestamp { get; } = DateTime.UtcNow;
    public string EventId { get; } = Guid.NewGuid().ToString();
}

// å…·ä½“äº‹ä»¶ç¤ºä¾‹
public class PlayerLoggedInEvent : GameEventBase
{
    public string PlayerId { get; init; }
    public string PlayerName { get; init; }
    public Vector3 Position { get; init; }
}
```

### 2. ä¸­ä»‹è€…ç³»ç»Ÿç»„ä»¶

#### Mediatoræ ¸å¿ƒç»„ä»¶

```csharp
// å¥‘çº¦å®šä¹‰
public interface IMyMediator
{
    Task<TResponse> Send<TResponse>(ICommand<TResponse> command, CancellationToken cancellationToken = default);
    Task<TResponse> Send<TResponse>(IQuery<TResponse> query, CancellationToken cancellationToken = default);
    Task Publish<T>(T notification, CancellationToken cancellationToken = default) where T : INotification;
}

// å‘½ä»¤å’ŒæŸ¥è¯¢æ¥å£
public interface ICommand<out TResponse> { }
public interface IQuery<out TResponse> { }
public interface INotification { }

// å¤„ç†å™¨æ¥å£
public interface ICommandHandler<in TCommand, TResponse> where TCommand : ICommand<TResponse>
{
    Task<TResponse> Handle(TCommand command, CancellationToken cancellationToken);
}

public interface IQueryHandler<in TQuery, TResponse> where TQuery : IQuery<TResponse>
{
    Task<TResponse> Handle(TQuery query, CancellationToken cancellationToken);
}
```

#### MediatRé€‚é…å™¨

```csharp
public class MediatRAdapter : IMyMediator
{
    private readonly IMediator _mediatR;
    private readonly ILogger<MediatRAdapter> _logger;
    
    public MediatRAdapter(IMediator mediatR, ILogger<MediatRAdapter> logger)
    {
        _mediatR = mediatR;
        _logger = logger;
    }
    
    public async Task<TResponse> Send<TResponse>(ICommand<TResponse> command, CancellationToken cancellationToken = default)
    {
        try
        {
            var wrapper = new MediatRCommandWrapper<TResponse>(command);
            return await _mediatR.Send(wrapper, cancellationToken);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Command execution failed: {CommandType}", command.GetType().Name);
            throw;
        }
    }
}

// é€‚é…å™¨åŒ…è£…å™¨
internal class MediatRCommandWrapper<TResponse> : IRequest<TResponse>
{
    public ICommand<TResponse> Command { get; }
    
    public MediatRCommandWrapper(ICommand<TResponse> command)
    {
        Command = command;
    }
}
```

### 3. ä¾èµ–æ³¨å…¥ç»„ä»¶

#### æœåŠ¡æ³¨å†Œ

```csharp
public static class ServiceCollectionExtensions
{
    public static IServiceCollection AddEventMediatorArchitecture(this IServiceCollection services)
    {
        // æ³¨å†Œå¥‘çº¦å®ç°
        services.AddSingleton<IEventBus, R3EventBus>();
        services.AddScoped<IMyMediator, MediatRAdapter>();
        
        // æ³¨å†ŒMediatR
        services.AddMediatR(cfg => cfg.RegisterServicesFromAssembly(Assembly.GetExecutingAssembly()));
        
        // æ³¨å†Œå¤„ç†å™¨å‘ç°
        services.AddTransient<IHandlerRegistry, HandlerRegistry>();
        
        return services;
    }
}
```

## æ¥å£è®¾è®¡

### 1. äº‹ä»¶ç³»ç»Ÿæ¥å£

#### IEventBusæ¥å£

```csharp
/// <summary>
/// äº‹ä»¶æ€»çº¿æ¥å£ï¼Œæä¾›å‘å¸ƒè®¢é˜…åŠŸèƒ½
/// </summary>
public interface IEventBus
{
    /// <summary>
    /// å‘å¸ƒäº‹ä»¶åˆ°æ‰€æœ‰è®¢é˜…è€…
    /// </summary>
    /// <typeparam name="T">äº‹ä»¶ç±»å‹</typeparam>
    /// <param name="eventData">äº‹ä»¶æ•°æ®</param>
    void Publish<T>(T eventData) where T : class;
    
    /// <summary>
    /// è®¢é˜…ç‰¹å®šç±»å‹çš„äº‹ä»¶
    /// </summary>
    /// <typeparam name="T">äº‹ä»¶ç±»å‹</typeparam>
    /// <param name="handler">äº‹ä»¶å¤„ç†å™¨</param>
    /// <returns>è®¢é˜…ä»¤ç‰Œï¼Œç”¨äºå–æ¶ˆè®¢é˜…</returns>
    IDisposable Subscribe<T>(Action<T> handler) where T : class;
    
    /// <summary>
    /// è·å–äº‹ä»¶çš„å¯è§‚å¯Ÿæµ
    /// </summary>
    /// <typeparam name="T">äº‹ä»¶ç±»å‹</typeparam>
    /// <returns>äº‹ä»¶æµ</returns>
    IObservable<T> GetObservable<T>() where T : class;
    
    /// <summary>
    /// è®¢é˜…äº‹ä»¶ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
    /// </summary>
    /// <typeparam name="T">äº‹ä»¶ç±»å‹</typeparam>
    /// <param name="handler">å¼‚æ­¥äº‹ä»¶å¤„ç†å™¨</param>
    /// <returns>è®¢é˜…ä»¤ç‰Œ</returns>
    IDisposable SubscribeAsync<T>(Func<T, Task> handler) where T : class;
}
```

#### IEventSubscriberæ¥å£

```csharp
/// <summary>
/// äº‹ä»¶è®¢é˜…è€…æ¥å£ï¼Œç”¨äºæ’ä»¶å®ç°
/// </summary>
public interface IEventSubscriber
{
    /// <summary>
    /// è®¢é˜…äº‹ä»¶
    /// </summary>
    /// <typeparam name="T">äº‹ä»¶ç±»å‹</typeparam>
    /// <param name="handler">å¤„ç†å™¨</param>
    /// <returns>è®¢é˜…ä»¤ç‰Œ</returns>
    IDisposable Subscribe<T>(Action<T> handler) where T : class;
    
    /// <summary>
    /// æ‰¹é‡è®¢é˜…å¤šä¸ªäº‹ä»¶ç±»å‹
    /// </summary>
    /// <param name="subscriptions">è®¢é˜…é…ç½®</param>
    /// <returns>å¤åˆè®¢é˜…ä»¤ç‰Œ</returns>
    IDisposable SubscribeMultiple(params EventSubscription[] subscriptions);
}

public class EventSubscription
{
    public Type EventType { get; init; }
    public Delegate Handler { get; init; }
    public bool IsAsync { get; init; }
}
```

### 2. ä¸­ä»‹è€…ç³»ç»Ÿæ¥å£

#### IMyMediatoræ¥å£

```csharp
/// <summary>
/// ä¸­ä»‹è€…æ¥å£ï¼Œå®ç°CQRSæ¨¡å¼
/// </summary>
public interface IMyMediator
{
    /// <summary>
    /// å‘é€å‘½ä»¤
    /// </summary>
    /// <typeparam name="TResponse">å“åº”ç±»å‹</typeparam>
    /// <param name="command">å‘½ä»¤å¯¹è±¡</param>
    /// <param name="cancellationToken">å–æ¶ˆä»¤ç‰Œ</param>
    /// <returns>å‘½ä»¤æ‰§è¡Œç»“æœ</returns>
    Task<TResponse> Send<TResponse>(ICommand<TResponse> command, CancellationToken cancellationToken = default);
    
    /// <summary>
    /// å‘é€æŸ¥è¯¢
    /// </summary>
    /// <typeparam name="TResponse">å“åº”ç±»å‹</typeparam>
    /// <param name="query">æŸ¥è¯¢å¯¹è±¡</param>
    /// <param name="cancellationToken">å–æ¶ˆä»¤ç‰Œ</param>
    /// <returns>æŸ¥è¯¢ç»“æœ</returns>
    Task<TResponse> Send<TResponse>(IQuery<TResponse> query, CancellationToken cancellationToken = default);
    
    /// <summary>
    /// å‘å¸ƒé€šçŸ¥åˆ°å¤šä¸ªå¤„ç†å™¨
    /// </summary>
    /// <typeparam name="T">é€šçŸ¥ç±»å‹</typeparam>
    /// <param name="notification">é€šçŸ¥å¯¹è±¡</param>
    /// <param name="cancellationToken">å–æ¶ˆä»¤ç‰Œ</param>
    Task Publish<T>(T notification, CancellationToken cancellationToken = default) where T : INotification;
}
```

#### å‘½ä»¤æŸ¥è¯¢æ¥å£

```csharp
/// <summary>
/// å‘½ä»¤æ¥å£æ ‡è®°
/// </summary>
/// <typeparam name="TResponse">å“åº”ç±»å‹</typeparam>
public interface ICommand<out TResponse> { }

/// <summary>
/// æŸ¥è¯¢æ¥å£æ ‡è®°
/// </summary>
/// <typeparam name="TResponse">å“åº”ç±»å‹</typeparam>
public interface IQuery<out TResponse> { }

/// <summary>
/// é€šçŸ¥æ¥å£æ ‡è®°
/// </summary>
public interface INotification { }

/// <summary>
/// å‘½ä»¤å¤„ç†å™¨æ¥å£
/// </summary>
/// <typeparam name="TCommand">å‘½ä»¤ç±»å‹</typeparam>
/// <typeparam name="TResponse">å“åº”ç±»å‹</typeparam>
public interface ICommandHandler<in TCommand, TResponse> where TCommand : ICommand<TResponse>
{
    Task<TResponse> Handle(TCommand command, CancellationToken cancellationToken);
}

/// <summary>
/// æŸ¥è¯¢å¤„ç†å™¨æ¥å£
/// </summary>
/// <typeparam name="TQuery">æŸ¥è¯¢ç±»å‹</typeparam>
/// <typeparam name="TResponse">å“åº”ç±»å‹</typeparam>
public interface IQueryHandler<in TQuery, TResponse> where TQuery : IQuery<TResponse>
{
    Task<TResponse> Handle(TQuery query, CancellationToken cancellationToken);
}

/// <summary>
/// é€šçŸ¥å¤„ç†å™¨æ¥å£
/// </summary>
/// <typeparam name="T">é€šçŸ¥ç±»å‹</typeparam>
public interface INotificationHandler<in T> where T : INotification
{
    Task Handle(T notification, CancellationToken cancellationToken);
}
```

## æ•°æ®æµè®¾è®¡

### 1. äº‹ä»¶å‘å¸ƒæµç¨‹

```
Plugin A                EventBus               Plugin B
   â”‚                       â”‚                     â”‚
   â”‚ 1. Publish(Event)     â”‚                     â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                     â”‚
   â”‚                       â”‚ 2. Distribute       â”‚
   â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                       â”‚                     â”‚ 3. Handle(Event)
   â”‚                       â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
   â”‚                       â”‚                     â”‚
   â”‚ 4. Continue           â”‚ 5. Ack              â”‚ 6. Complete
   â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
```

### 2. å‘½ä»¤å¤„ç†æµç¨‹

```
Plugin                 Mediator              Handler
   â”‚                      â”‚                     â”‚
   â”‚ 1. Send(Command)     â”‚                     â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                     â”‚
   â”‚                      â”‚ 2. Route            â”‚
   â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                      â”‚                     â”‚ 3. Handle
   â”‚                      â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
   â”‚                      â”‚ 4. Response         â”‚
   â”‚                      â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ 5. Result            â”‚                     â”‚
   â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
```

### 3. é”™è¯¯å¤„ç†æµç¨‹

```
Component              Error Handler          Logger
   â”‚                      â”‚                     â”‚
   â”‚ 1. Exception         â”‚                     â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                     â”‚
   â”‚                      â”‚ 2. Log Error        â”‚
   â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                      â”‚ 3. Recover          â”‚
   â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º      â”‚
   â”‚ 4. Fallback          â”‚                     â”‚
   â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
```

## å®‰å…¨è®¾è®¡

### 1. è¾“å…¥éªŒè¯

```csharp
public class EventValidationMiddleware : IEventMiddleware
{
    public async Task<bool> ProcessAsync<T>(T eventData) where T : class
    {
        // éªŒè¯äº‹ä»¶æ•°æ®
        if (eventData == null)
            throw new ArgumentNullException(nameof(eventData));
            
        // éªŒè¯äº‹ä»¶ç±»å‹
        if (!IsValidEventType<T>())
            throw new InvalidOperationException($"Invalid event type: {typeof(T).Name}");
            
        // éªŒè¯äº‹ä»¶å†…å®¹
        var validationResult = await ValidateEventContent(eventData);
        if (!validationResult.IsValid)
            throw new ValidationException(validationResult.Errors);
            
        return true;
    }
}
```

### 2. æƒé™æ§åˆ¶

```csharp
public class EventAuthorizationMiddleware : IEventMiddleware
{
    private readonly IAuthorizationService _authService;
    
    public async Task<bool> ProcessAsync<T>(T eventData) where T : class
    {
        var eventType = typeof(T);
        var currentUser = GetCurrentUser();
        
        var authResult = await _authService.AuthorizeAsync(currentUser, eventData, "EventPublish");
        
        if (!authResult.Succeeded)
        {
            throw new UnauthorizedAccessException($"User {currentUser.Id} not authorized to publish {eventType.Name}");
        }
        
        return true;
    }
}
```

### 3. æ•°æ®ä¿æŠ¤

```csharp
public class EventEncryptionMiddleware : IEventMiddleware
{
    private readonly IDataProtector _protector;
    
    public async Task<bool> ProcessAsync<T>(T eventData) where T : class
    {
        if (eventData is ISensitiveEvent sensitiveEvent)
        {
            // åŠ å¯†æ•æ„Ÿæ•°æ®
            sensitiveEvent.EncryptSensitiveData(_protector);
        }
        
        return true;
    }
}
```

## æ€§èƒ½è®¾è®¡

### 1. é›¶åˆ†é…ä¼˜åŒ–

```csharp
public class ZeroAllocEventBus : IEventBus
{
    private readonly ObjectPool<EventContext> _contextPool;
    private readonly ConcurrentDictionary<Type, FastSubject> _subjects;
    
    public void Publish<T>(T eventData) where T : class
    {
        var context = _contextPool.Get();
        try
        {
            context.EventData = eventData;
            context.EventType = typeof(T);
            
            if (_subjects.TryGetValue(typeof(T), out var subject))
            {
                subject.OnNext(context);
            }
        }
        finally
        {
            _contextPool.Return(context);
        }
    }
}
```

### 2. æ‰¹é‡å¤„ç†

```csharp
public class BatchEventProcessor : IEventProcessor
{
    private readonly Channel<EventBatch> _channel;
    private readonly Timer _flushTimer;
    
    public async Task ProcessBatchAsync(EventBatch batch)
    {
        var tasks = new Task[batch.Events.Count];
        
        for (int i = 0; i < batch.Events.Count; i++)
        {
            tasks[i] = ProcessSingleEventAsync(batch.Events[i]);
        }
        
        await Task.WhenAll(tasks);
    }
}
```

### 3. ç¼“å­˜ä¼˜åŒ–

```csharp
public class CachedHandlerRegistry : IHandlerRegistry
{
    private readonly ConcurrentDictionary<Type, HandlerInfo[]> _handlerCache;
    private readonly IMemoryCache _typeCache;
    
    public HandlerInfo[] GetHandlers<T>()
    {
        return _handlerCache.GetOrAdd(typeof(T), type =>
        {
            return DiscoverHandlers(type).ToArray();
        });
    }
}
```

## æ‰©å±•æ€§è®¾è®¡

### 1. æ’ä»¶æ¥å£

```csharp
public interface IEventPlugin
{
    string Name { get; }
    Version Version { get; }
    
    Task InitializeAsync(IEventBus eventBus, IServiceProvider services);
    Task ShutdownAsync();
    
    IEnumerable<Type> GetEventTypes();
    IEnumerable<Type> GetHandlerTypes();
}
```

### 2. ä¸­é—´ä»¶ç®¡é“

```csharp
public interface IEventMiddleware
{
    Task<bool> ProcessAsync<T>(T eventData) where T : class;
}

public class EventMiddlewarePipeline
{
    private readonly List<IEventMiddleware> _middlewares;
    
    public async Task<bool> ExecuteAsync<T>(T eventData) where T : class
    {
        foreach (var middleware in _middlewares)
        {
            if (!await middleware.ProcessAsync(eventData))
                return false;
        }
        return true;
    }
}
```

### 3. é…ç½®ç³»ç»Ÿ

```csharp
public class EventBusConfiguration
{
    public int MaxConcurrentEvents { get; set; } = 1000;
    public TimeSpan EventTimeout { get; set; } = TimeSpan.FromSeconds(30);
    public bool EnableBatching { get; set; } = true;
    public int BatchSize { get; set; } = 100;
    public TimeSpan BatchTimeout { get; set; } = TimeSpan.FromMilliseconds(10);
    
    public List<Type> MiddlewareTypes { get; set; } = new();
    public Dictionary<string, object> CustomSettings { get; set; } = new();
}
```

---

## æ€»ç»“

æœ¬è®¾è®¡è§„èŒƒåŸºäº"åˆ†ç¦»æŠ½è±¡ä¸å®ç°"çš„æ ¸å¿ƒåŸåˆ™ï¼Œé€šè¿‡æ¸…æ™°çš„åˆ†å±‚æ¶æ„ã€ç¨³å®šçš„æ¥å£å¥‘çº¦å’Œé«˜æ•ˆçš„å®ç°ç­–ç•¥ï¼Œä¸ºModularGodot.Coreæ¡†æ¶æä¾›äº†ä¸€ä¸ªå¥å£®ã€é«˜æ€§èƒ½ã€å¯æ‰©å±•çš„äº‹ä»¶ç³»ç»Ÿå’Œä¸­ä»‹è€…æ¨¡å¼æ¶æ„ã€‚

**å…³é”®è®¾è®¡ç‰¹å¾**ï¼š
- **å¥‘çº¦ç¨³å®šæ€§**ï¼šæ ¸å¿ƒæ¥å£è®¾è®¡ä¿æŒé•¿æœŸç¨³å®š
- **å®ç°çµæ´»æ€§**ï¼šæ”¯æŒå¤šç§å®ç°ç­–ç•¥å’Œè¿è¡Œæ—¶æ›¿æ¢
- **æ€§èƒ½ä¼˜åŒ–**ï¼šé›¶åˆ†é…äº‹ä»¶å¤„ç†å’Œæ‰¹é‡ä¼˜åŒ–
- **æ‰©å±•èƒ½åŠ›**ï¼šå®Œå–„çš„æ’ä»¶ç³»ç»Ÿå’Œä¸­é—´ä»¶æ”¯æŒ

è¯¥è®¾è®¡ä¸ºæ„å»ºå¤§è§„æ¨¡ã€é«˜æ€§èƒ½çš„æ¨¡å—åŒ–æ¸¸æˆç³»ç»Ÿå¥ å®šäº†åšå®çš„æ¶æ„åŸºç¡€ã€‚