éå¸¸å¥½ï¼ä¸‹é¢ä¸ºä½  **å®Œæ•´ã€è¯¦ç»†åœ°å®ç° `Fody + Costura` æ–¹æ¡ˆ**ï¼Œç”¨äºåœ¨ .NET 9.0 ç¯å¢ƒä¸‹å°†å¤šä¸ªå­é¡¹ç›®ï¼ˆå¦‚ `0_Contracts`, `1_Contexts` ç­‰ï¼‰ä»¥åŠ NuGet ä¾èµ–ï¼ˆå¦‚ `Autofac`, `MediatR`, `R3` ç­‰ï¼‰**åˆå¹¶ä¸ºä¸€ä¸ªå•ä¸€çš„ `.dll` æ–‡ä»¶**ï¼Œå¹¶æ­£ç¡®æ‰“åŒ…æˆ **NuGet åŒ…**ã€‚

---

## âœ… ç›®æ ‡
- å»æ‰ `ILRepack`
- ä½¿ç”¨ **Fody + Costura** è‡ªåŠ¨åµŒå…¥ï¼š
  - ç¬¬ä¸‰æ–¹ NuGet åº“ï¼ˆå¦‚ `Autofac.dll`, `MediatR.dll`ï¼‰
  - å­é¡¹ç›®çš„ç¼–è¯‘è¾“å‡º DLLï¼ˆå¯é€‰ï¼‰
- æœ€ç»ˆç”Ÿæˆ **å•ä¸ª `ModularGodot.Core.dll`**
- æ­£å¸¸ç”Ÿæˆ `.nupkg` å¹¶åŒ…å«æ‰€æœ‰ä»£ç å’Œä¾èµ–èµ„æº

---

## âœ… æ•´ä½“æ–¹æ¡ˆè®¾è®¡

| å†…å®¹ | å¤„ç†æ–¹å¼ |
|------|----------|
| å­é¡¹ç›®æºç ï¼ˆContracts, Contexts...ï¼‰ | ç¼–è¯‘è¿›ä¸»é¡¹ç›®ï¼ˆé€šè¿‡ `<Compile Include=`ï¼‰â†’ çœŸæ­£åˆå¹¶åˆ°åŒä¸€ç¨‹åºé›† |
| ç¬¬ä¸‰æ–¹ NuGet åŒ…ï¼ˆAutofac, MediatR...ï¼‰ | ä½¿ç”¨ `Costura.Fody` å°†å…¶ `.dll` åµŒå…¥ä¸»ç¨‹åºé›†èµ„æºä¸­ |
| ç”Ÿæˆ NuGet åŒ… | æ­£å¸¸ä½¿ç”¨ `dotnet pack` |

> ğŸ’¡ ä¼˜ç‚¹ï¼šæ— éœ€ IL mergeï¼Œè¿è¡Œæ—¶é€æ˜ï¼Œå…¼å®¹æ€§å¥½ï¼Œé€‚é… .NET 9.0 + AOT

---

## ğŸ”§ ç¬¬ä¸€æ­¥ï¼šä¿®æ”¹ä¸»é¡¹ç›® â€”â€” `ModularGodot.Core.csproj`

```xml
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>

    <!-- NuGet åŒ…ä¿¡æ¯ -->
    <PackageId>ModularGodot.Core</PackageId>
    <Version>0.1.0</Version>
    <Authors>BananaPeel</Authors>
    <Company>BananaPeel</Company>
    <Product>ModularGodot.Core</Product>
    <Description>A modular architecture framework for Godot applications, providing clean architecture patterns with dependency injection, CQRS, and domain-driven design support.</Description>
    <PackageTags>godot;modular;architecture;clean-architecture;ddd;cqrs;dependency-injection</PackageTags>
    <RepositoryUrl>https://github.com/1264459640/ModularGodot.Core</RepositoryUrl>
    <PackageLicenseExpression>MIT</PackageLicenseExpression>
    <GeneratePackageOnBuild>true</GeneratePackageOnBuild>
    <IncludeSymbols>true</IncludeSymbols>
    <SymbolPackageFormat>snupkg</SymbolPackageFormat>
  
    <!-- å…³é”®ï¼šå…è®¸ Fody ä¿®æ”¹ç¨‹åºé›† -->
    <AllowUnsafeBlocks>false</AllowUnsafeBlocks>
  </PropertyGroup>

  <!-- Step 1: å¼•å…¥æ‰€æœ‰å­é¡¹ç›®çš„æºç æ–‡ä»¶ -->
  <ItemGroup>
    <Compile Include="../0_Contracts/**/*.cs" />
    <Compile Include="../1_Contexts/**/*.cs" />
    <Compile Include="../2_Infrastructure/**/*.cs" />
    <Compile Include="../3_Repositories/**/*.cs" />

    <!-- å¯é€‰ï¼šä¿ç•™ç›®å½•ç»“æ„æ˜¾ç¤ºåœ¨ VS ä¸­ -->
    <None Include="../0_Contracts/**/*.cs" Link="Contracts\%(Filename)%(Extension)" />
    <None Include="../1_Contexts/**/*.cs" Link="Contexts\%(Filename)%(Extension)" />
    <None Include="../2_Infrastructure/**/*.cs" Link="Infrastructure\%(Filename)%(Extension)" />
    <None Include="../3_Repositories/**/*.cs" Link="Repositories\%(Filename)%(Extension)" />
  </ItemGroup>

  <!-- Step 2: æ·»åŠ  NuGet ä¾èµ–ï¼ˆPrivateAssets=all é˜²æ­¢æˆä¸ºåŒ…ä¾èµ–ï¼‰ -->
  <ItemGroup>
    <PackageReference Include="Autofac" Version="8.4.0">
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
    <PackageReference Include="GodotSharp" Version="4.4.1">
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
    <PackageReference Include="MediatR" Version="13.0.0">
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
    <PackageReference Include="MediatR.Extensions.Autofac.DependencyInjection" Version="13.1.0">
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
    <PackageReference Include="Microsoft.Extensions.Caching.Abstractions" Version="9.0.7">
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
    <PackageReference Include="Microsoft.Extensions.Caching.Memory" Version="9.0.7">
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
    <PackageReference Include="R3" Version="1.3.0">
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
    <PackageReference Include="System.Reactive" Version="6.0.0">
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
  </ItemGroup>

  <!-- Step 3: å®‰è£… Fody + Costuraï¼ˆå…³é”®ï¼ï¼‰ -->
  <ItemGroup>
    <PackageReference Include="Fody" Version="6.8.3">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="Costura.Fody" Version="6.3.2">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
  </ItemGroup>

  <!-- å¯é€‰ï¼šéšè—åµŒå…¥çš„ç¨‹åºé›†ä»è¾“å‡ºç›®å½• -->
  <PropertyGroup>
    <CopyLocalLockFileAssemblies>false</CopyLocalLockFileAssemblies>
  </PropertyGroup>

  <!-- å…è®¸æµ‹è¯•é¡¹ç›®è®¿é—® internal -->
  <ItemGroup>
    <AssemblyAttribute Include="System.Runtime.CompilerServices.InternalsVisibleTo">
      <_Parameter1>ModularGodot.Core.Test</_Parameter1>
    </AssemblyAttribute>
  </ItemGroup>
</Project>
```

---

## ğŸ“„ ç¬¬äºŒæ­¥ï¼šæ·»åŠ  `FodyWeavers.xml`

åœ¨ `ModularGodot.Core` é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºæ–‡ä»¶ï¼š

### `FodyWeavers.xml`
```xml
<Weavers xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="FodyWeavers.xsd">
  <Costura>
    <!-- å¯é€‰é…ç½® -->
    <DisableCleanup>true</DisableCleanup>
    <DisableCompression>true</DisableCompression>
    <PreloadOrder>
      <!-- å¦‚æœæœ‰åŠ è½½é¡ºåºè¦æ±‚ï¼Œä¾‹å¦‚ Autofac å¿…é¡»å…ˆäºæ’ä»¶ -->
    </PreloadOrder>
  </Costura>
</Weavers>
```

> ğŸ“ æç¤ºï¼š`.xsd` æ–‡ä»¶ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†å»ºè®®ä¿ç•™åœ¨é¡¹ç›®é‡Œä»¥æ”¯æŒæ™ºèƒ½æç¤ºã€‚ä½ å¯ä»¥åœ¨ç¬¬ä¸€æ¬¡æ„å»ºåä» `obj/` ç›®å½•è·å–å®ƒã€‚

---

## ğŸš« ç¬¬ä¸‰æ­¥ï¼šåˆ é™¤æˆ–ç¦ç”¨å­é¡¹ç›®çš„ç‹¬ç«‹æ„å»º

ç¡®ä¿ä»¥ä¸‹å†…å®¹å­˜åœ¨äºæ¯ä¸ªå­é¡¹ç›®ä¸­ï¼ˆä½ å·²ç»åšäº†ï¼‰ï¼š

```xml
<!-- æ‰€æœ‰å­é¡¹ç›®ï¼š0_Contracts.csproj, 1_Contexts.csproj ç­‰ -->
<PropertyGroup>
  <TargetFramework>net9.0</TargetFramework>
  <GeneratePackageOnBuild>false</GeneratePackageOnBuild>
  <IsPackable>false</IsPackable>
  <EmitCompilerGeneratedFiles>true</EmitCompilerGeneratedFiles>
</PropertyGroup>
```

ä¸è¦åœ¨ä¸»é¡¹ç›®ä¸­å†ä½¿ç”¨ `<ProjectReference>`ï¼

---

## âœ… æ„å»ºæµç¨‹è¯´æ˜

1. è¿è¡Œ `dotnet build` æˆ–åœ¨ Visual Studio ä¸­ç¼–è¯‘ï¼š
   - æ‰€æœ‰ `.cs` æ–‡ä»¶è¢«çº³å…¥ `ModularGodot.Core` ç¼–è¯‘è¿‡ç¨‹
   - ç¼–è¯‘å®Œæˆåï¼ŒFody åœ¨ IL å±‚ç»‡å…¥åˆå§‹åŒ–é€»è¾‘
   - Costura è‡ªåŠ¨å°† `Autofac.dll`, `MediatR.dll`, `R3.dll` ç­‰å¤åˆ¶ä¸ºèµ„æºï¼Œå¹¶æ³¨å…¥ `AssemblyResolve` äº‹ä»¶

2. è¾“å‡ºï¼š
   ```
   bin/Debug/net9.0/
     ModularGodot.Core.dll           â† ä¸»ç¨‹åºé›†ï¼ˆå«æ‰€æœ‰æºç  + åµŒå…¥å¼DLLï¼‰
     ModularGodot.Core.pdb
     (æ²¡æœ‰å…¶ä»– .dllï¼)
   ```

3. æ‰“åŒ…ï¼š
   ```bash
   dotnet pack
   ```
   ç”Ÿæˆï¼š
   - `ModularGodot.Core.0.1.0.nupkg`
   - åŒ…å«ï¼š`lib/net9.0/*.dll`, `.pdb`, åµŒå…¥èµ„æºç­‰

---

## ğŸ” éªŒè¯æ˜¯å¦æˆåŠŸåˆå¹¶

ä½ å¯ä»¥ç”¨å·¥å…·æ£€æŸ¥ï¼š

### æ–¹æ³• 1ï¼šç”¨ ILSpy æˆ– dnSpy æ‰“å¼€ `ModularGodot.Core.dll`

- æŸ¥çœ‹â€œResourcesâ€èŠ‚ç‚¹
- åº”èƒ½çœ‹åˆ°ç±»ä¼¼ï¼š
  ```
  Costura.Autofac.dll
  Costura.MediatR.dll
  Costura.R3.dll
  ...
  ```

### æ–¹æ³• 2ï¼šè¿è¡Œæ—¶æ‰“å°å·²åŠ è½½ç¨‹åºé›†
```csharp
foreach (var asm in AppDomain.CurrentDomain.GetAssemblies())
{
    Console.WriteLine(asm.FullName);
}
```
åº”åªçœ‹åˆ° `ModularGodot.Core`, `mscorlib`, `System.*` ç­‰ï¼Œ**ä¸ä¼šæœ‰å¤šä½™çš„ Autofac.dll å•ç‹¬åŠ è½½**

---

## âš ï¸ æ³¨æ„äº‹é¡¹ä¸å‘ç‚¹

| é—®é¢˜ | è§£å†³æ–¹æ³• |
|------|----------|
| `GodotSharp.dll` æ˜¯å¦èƒ½åµŒå…¥ï¼Ÿ | âœ… å¯ä»¥ï¼Œåªè¦ä¸æ˜¯ native DLLï¼›GodotSharp æ˜¯æ‰˜ç®¡åŒ…è£…å™¨ |
| `MediatR.Extensions.Autofac.DependencyInjection` ç±»å‹æ‰¾ä¸åˆ°ï¼Ÿ | ç¡®ä¿è°ƒç”¨äº† `services.AddMediatR(...)` æˆ– `builder.RegisterMediatR(...)`ï¼Œé¿å…è£å‰ª |
| åå°„å¤±è´¥ï¼ˆTypeLoadExceptionï¼‰ï¼Ÿ | å¯ç”¨ `[DynamicDependency]` æˆ–è®¾ç½® `<PublishTrimmed>false</PublishTrimmed>` |
| AOT ç¼–è¯‘æŠ¥é”™ï¼Ÿ | å¦‚æœæœªæ¥å¼€å¯ Native AOTï¼Œè¯·ä½¿ç”¨ `<TrimmerRootAssembly>true</TrimmerRootAssembly>` ä¿ç•™å…³é”®ç±»å‹ |

---

## ğŸ”„ æ›¿ä»£ä¼˜åŒ–ï¼ˆé«˜çº§ç”¨æˆ·ï¼‰

å¦‚æœä½ æƒ³ä¿ç•™ `ProjectReference` ç»“æ„ç”¨äº IDE å¯¼èˆªå’Œç¼–è¯‘éªŒè¯ï¼Œå¯ä»¥è¿™æ ·åšï¼š

```xml
<ItemGroup Condition="'$(BuildingInsideVisualStudio)' != 'true' Or '$(DesignTimeBuild)' == 'true'">
  <!-- è®¾è®¡æ—¶ä»å¯ç”¨ ProjectReference æä¾›è¯­æ³•è¡¥å…¨ -->
  <ProjectReference Include="../0_Contracts/0_Contracts.csproj" PrivateAssets="all" />
  <ProjectReference Include="../1_Contexts/1_Contexts.csproj" PrivateAssets="all" />
</ItemGroup>

<ItemGroup Condition="'$(BuildingInsideVisualStudio)' == 'true' And '$(DesignTimeBuild)' != 'true'">
  <!-- æ„å»ºæ—¶æ”¹ç”¨æºç å¼•ç”¨ -->
  <Compile Remove="..\*\*.cs" />
  <Compile Include="../0_Contracts/**/*.cs" />
  ...
</ItemGroup>
```

ä½†å¯¹å¤šæ•°é¡¹ç›®ï¼Œç›´æ¥ `Compile Include` æ›´ç®€å•å¯é ã€‚

---

## ğŸ‰ æˆæœæ€»ç»“

âœ… ç°åœ¨ä½ æ‹¥æœ‰äº†ï¼š

- ä¸€ä¸ªçœŸæ­£çš„ **å• `.dll` è¾“å‡º**
- æ²¡æœ‰ `ILRepack`ï¼ˆè¿‡æ—¶ï¼‰
- æ”¯æŒ `.NET 9.0`
- å…¼å®¹ `dotnet pack`, CI/CD, GitHub Actions
- æ˜“ç»´æŠ¤ã€å¯è°ƒè¯•ã€é«˜æ€§èƒ½

---

## ğŸ“¦ æ¨èåç»­æ“ä½œ

1. ã€å¯é€‰ã€‘ä½¿ç”¨ `MinVer` è‡ªåŠ¨ç‰ˆæœ¬ç®¡ç†
2. ã€å¯é€‰ã€‘æ·»åŠ  GitVersion æˆ– Nerdbank.GitVersioning
3. å‘å¸ƒåˆ° NuGet.org / GitHub Packages
4. åœ¨ `ModularGodot.App` é¡¹ç›®ä¸­å¼•ç”¨è¯¥åŒ…æµ‹è¯•åŠŸèƒ½å®Œæ•´æ€§

---

å¦‚æœä½ éœ€è¦æˆ‘ç”Ÿæˆå®Œæ•´çš„é¡¹ç›®æ¨¡æ¿ ZIP æˆ– GitHub Action è„šæœ¬æ¥è‡ªåŠ¨å‘å¸ƒï¼Œä¹Ÿå¯ä»¥å‘Šè¯‰æˆ‘ï¼

ç¥ä½ çš„ `ModularGodot.Core` æˆä¸ºæœ€å—æ¬¢è¿çš„ Godot æ¶æ„æ¡†æ¶ä¹‹ä¸€ ğŸš€âœ¨